<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug - Simple</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background: #d4edda; border-color: #c3e6cb; }
        .fail { background: #f8d7da; border-color: #f5c6cb; }
        .loading { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üîç Authentication Debug Tool</h1>
    <p>This will help us identify exactly what's broken with your authentication.</p>
    
    <div id="step1" class="test loading">
        <h3>Step 1: Basic Page Load</h3>
        <div id="step1-result">Testing...</div>
    </div>
    
    <div id="step2" class="test loading">
        <h3>Step 2: Script Loading</h3>
        <div id="step2-result">Waiting...</div>
    </div>
    
    <div id="step3" class="test loading">
        <h3>Step 3: Configuration</h3>
        <div id="step3-result">Waiting...</div>
    </div>
    
    <div id="step4" class="test loading">
        <h3>Step 4: Supabase Connection</h3>
        <div id="step4-result">Waiting...</div>
        <button onclick="testSupabaseConnection()" id="test-supabase-btn">Test Supabase</button>
    </div>
    
    <div id="step5" class="test loading">
        <h3>Step 5: Auth Manager</h3>
        <div id="step5-result">Waiting...</div>
        <button onclick="testAuthManager()" id="test-auth-btn">Test Auth Manager</button>
    </div>
    
    <div id="step6" class="test loading">
        <h3>Step 6: Simple Auth Test</h3>
        <div id="step6-result">Ready for testing</div>
        <button onclick="testEmailAuth()" id="test-email-btn">Test Email Auth</button>
        <button onclick="testGoogleAuth()" id="test-google-btn">Test Google Auth</button>
    </div>
    
    <div id="console-output" class="test">
        <h3>Console Output</h3>
        <pre id="console-log"></pre>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <!-- Load scripts step by step -->
    <script>
        let consoleOutput = [];
        let originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };
        
        // Intercept console output
        function logToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            consoleOutput.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateConsoleDisplay();
            
            // Call original console method
            originalConsole[type](...args);
        }
        
        console.log = (...args) => logToConsole('log', ...args);
        console.error = (...args) => logToConsole('error', ...args);
        console.warn = (...args) => logToConsole('warn', ...args);
        
        function updateConsoleDisplay() {
            document.getElementById('console-log').textContent = consoleOutput.slice(-20).join('\n');
        }
        
        function clearConsole() {
            consoleOutput = [];
            updateConsoleDisplay();
        }
        
        function updateStep(stepId, message, status = 'loading') {
            const step = document.getElementById(stepId);
            const result = document.getElementById(stepId + '-result');
            
            result.innerHTML = message;
            step.className = `test ${status}`;
            
            console.log(`Step ${stepId}: ${status} - ${message.replace(/<[^>]*>/g, '')}`);
        }
        
        // Step 1: Basic page load
        function testBasicLoad() {
            try {
                updateStep('step1', '‚úÖ Page loaded successfully', 'pass');
                testScriptLoading();
            } catch (error) {
                updateStep('step1', `‚ùå Page load failed: ${error.message}`, 'fail');
            }
        }
        
        // Step 2: Test script loading
        function testScriptLoading() {
            const scripts = [
                'js/config.js',
                'js/public-config.js',
                'js/supabase-client.js',
                'js/auth-manager.js'
            ];
            
            let loadedScripts = [];
            let failedScripts = [];
            
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedScripts.push(src);
                    console.log(`‚úÖ Loaded: ${src}`);
                    checkScriptLoadingComplete();
                };
                script.onerror = () => {
                    failedScripts.push(src);
                    console.error(`‚ùå Failed to load: ${src}`);
                    checkScriptLoadingComplete();
                };
                
                if (src.includes('supabase-client.js')) {
                    script.type = 'module';
                }
                
                document.head.appendChild(script);
            });
            
            function checkScriptLoadingComplete() {
                if (loadedScripts.length + failedScripts.length === scripts.length) {
                    if (failedScripts.length === 0) {
                        updateStep('step2', `‚úÖ All scripts loaded: ${loadedScripts.join(', ')}`, 'pass');
                        setTimeout(testConfiguration, 1000);
                    } else {
                        updateStep('step2', `‚ùå Failed scripts: ${failedScripts.join(', ')}<br>‚úÖ Loaded: ${loadedScripts.join(', ')}`, 'fail');
                    }
                }
            }
        }
        
        // Step 3: Test configuration
        function testConfiguration() {
            try {
                if (!window.PUBLIC_ENV) {
                    throw new Error('PUBLIC_ENV not loaded');
                }
                
                if (!window.PUBLIC_ENV.SUPABASE_URL) {
                    throw new Error('SUPABASE_URL missing from PUBLIC_ENV');
                }
                
                if (!window.PUBLIC_ENV.SUPABASE_ANON_KEY) {
                    throw new Error('SUPABASE_ANON_KEY missing from PUBLIC_ENV');
                }
                
                updateStep('step3', `‚úÖ Configuration loaded<br>URL: ${window.PUBLIC_ENV.SUPABASE_URL}<br>Key: ${window.PUBLIC_ENV.SUPABASE_ANON_KEY.substring(0, 20)}...`, 'pass');
                
            } catch (error) {
                updateStep('step3', `‚ùå Configuration failed: ${error.message}`, 'fail');
            }
        }
        
        // Step 4: Test Supabase connection
        window.testSupabaseConnection = async function() {
            try {
                updateStep('step4', 'üîÑ Testing Supabase connection...', 'loading');
                
                if (!window.supabase) {
                    throw new Error('Supabase client not available');
                }
                
                const { data, error } = await window.supabase.auth.getSession();
                
                if (error && error.message !== 'Invalid session') {
                    throw error;
                }
                
                updateStep('step4', `‚úÖ Supabase connected<br>Session: ${data.session ? 'Active' : 'None'}`, 'pass');
                
            } catch (error) {
                updateStep('step4', `‚ùå Supabase connection failed: ${error.message}`, 'fail');
            }
        };
        
        // Step 5: Test Auth Manager
        window.testAuthManager = function() {
            try {
                if (!window.authManager) {
                    throw new Error('AuthManager not available');
                }
                
                const isAuth = window.authManager.isAuthenticated();
                const user = window.authManager.getCurrentUser();
                
                updateStep('step5', `‚úÖ AuthManager available<br>Authenticated: ${isAuth}<br>User: ${user ? user.email : 'None'}`, 'pass');
                
            } catch (error) {
                updateStep('step5', `‚ùå AuthManager failed: ${error.message}`, 'fail');
            }
        };
        
        // Step 6: Test email auth
        window.testEmailAuth = async function() {
            try {
                updateStep('step6', 'üîÑ Testing email authentication...', 'loading');
                
                if (!window.authManager) {
                    throw new Error('AuthManager not available');
                }
                
                // Try with test credentials (will likely fail, but we can see the error)
                const result = await window.authManager.signIn('test@example.com', 'testpassword');
                updateStep('step6', '‚úÖ Email auth function works (credentials invalid as expected)', 'pass');
                
            } catch (error) {
                if (error.message.includes('Invalid login credentials')) {
                    updateStep('step6', '‚úÖ Email auth function works (test credentials rejected as expected)', 'pass');
                } else {
                    updateStep('step6', `‚ùå Email auth failed: ${error.message}`, 'fail');
                }
            }
        };
        
        // Test Google auth
        window.testGoogleAuth = async function() {
            try {
                updateStep('step6', 'üîÑ Testing Google authentication...', 'loading');
                
                if (!window.authManager) {
                    throw new Error('AuthManager not available');
                }
                
                await window.authManager.signInWithProvider('google');
                updateStep('step6', '‚úÖ Google auth initiated (should redirect)', 'pass');
                
            } catch (error) {
                updateStep('step6', `‚ùå Google auth failed: ${error.message}`, 'fail');
            }
        };
        
        // Handle errors
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
        
        // Start testing
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Starting authentication debug...');
            testBasicLoad();
        });
    </script>
</body>
</html>