<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Image Converter App</title>
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="analytics-container">
        <div class="back-nav mb-6">
            <a href="/dashboard.html" class="text-blue-600 hover:underline">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>

        <div class="analytics-header">
            <h1 class="text-3xl font-bold mb-2">Usage Analytics</h1>
            <p class="opacity-90">Insights into your tool usage and activity patterns</p>
        </div>      
  <!-- Analytics Controls -->
        <div class="analytics-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Analytics Overview</h2>
                <div class="flex gap-2">
                    <select id="timeRange" class="px-3 py-2 border rounded-lg">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                    </select>
                    <button id="exportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEvents">0</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueTools">0</div>
                    <div class="stat-label">Tools Used</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgDaily">0</div>
                    <div class="stat-label">Avg Daily Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="topTool">-</div>
                    <div class="stat-label">Most Used Tool</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="analytics-card">
                <h3 class="text-lg font-semibold mb-4">Tool Usage</h3>
                <div class="chart-container">
                    <canvas id="toolUsageChart"></canvas>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="text-lg font-semibold mb-4">Daily Activity</h3>
                <div class="chart-container">
                    <canvas id="dailyActivityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Privacy Settings -->
        <div class="analytics-card">
            <h3 class="text-lg font-semibold mb-4">Privacy Settings</h3>
            <div class="space-y-4">
                <label class="flex items-center">
                    <input type="checkbox" id="trackingEnabled" class="mr-3">
                    <span>Enable usage analytics tracking</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="anonymizeData" class="mr-3">
                    <span>Anonymize personal data</span>
                </label>
                <div class="flex items-center gap-4">
                    <span>Data retention:</span>
                    <select id="retentionDays" class="px-3 py-2 border rounded">
                        <option value="30">30 days</option>
                        <option value="90" selected>90 days</option>
                        <option value="365">1 year</option>
                    </select>
                </div>
                <button id="savePrivacyBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/analytics-manager.js"></script>
    <script src="js/auth-guards.js"></script>

    <script>
        class AnalyticsUI {
            constructor() {
                this.analyticsManager = null;
                this.authManager = null;
                this.charts = {};
                this.init();
            }

            async init() {
                await this.waitForManagers();
                
                if (!this.authManager.isAuthenticated()) {
                    window.location.href = '/auth.html';
                    return;
                }

                this.setupEventListeners();
                await this.loadAnalyticsData();
                this.loadPrivacySettings();
            }

            async waitForManagers() {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.analyticsManager && window.authManager) {
                            this.analyticsManager = window.analyticsManager;
                            this.authManager = window.authManager;
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }

            setupEventListeners() {
                document.getElementById('timeRange').addEventListener('change', () => {
                    this.loadAnalyticsData();
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('savePrivacyBtn').addEventListener('click', () => {
                    this.savePrivacySettings();
                });
            }

            async loadAnalyticsData() {
                try {
                    const timeRange = document.getElementById('timeRange').value;
                    const analytics = await this.analyticsManager.getUserAnalytics(timeRange);
                    
                    if (analytics) {
                        this.updateStats(analytics);
                        this.updateCharts(analytics);
                    }
                } catch (error) {
                    console.error('Error loading analytics:', error);
                }
            }

            updateStats(analytics) {
                document.getElementById('totalEvents').textContent = analytics.totalEvents;
                document.getElementById('uniqueTools').textContent = Object.keys(analytics.toolUsage).length;
                document.getElementById('avgDaily').textContent = 
                    Math.round(analytics.totalEvents / Math.max(1, Object.keys(analytics.dailyUsage).length));
                document.getElementById('topTool').textContent = 
                    analytics.topTools[0]?.tool || 'None';
            }

            updateCharts(analytics) {
                this.createToolUsageChart(analytics.toolUsage);
                this.createDailyActivityChart(analytics.dailyUsage);
            }

            createToolUsageChart(toolUsage) {
                const ctx = document.getElementById('toolUsageChart').getContext('2d');
                
                if (this.charts.toolUsage) {
                    this.charts.toolUsage.destroy();
                }

                this.charts.toolUsage = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(toolUsage),
                        datasets: [{
                            data: Object.values(toolUsage),
                            backgroundColor: [
                                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            createDailyActivityChart(dailyUsage) {
                const ctx = document.getElementById('dailyActivityChart').getContext('2d');
                
                if (this.charts.dailyActivity) {
                    this.charts.dailyActivity.destroy();
                }

                const sortedDates = Object.keys(dailyUsage).sort();
                
                this.charts.dailyActivity = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Daily Usage',
                            data: sortedDates.map(date => dailyUsage[date]),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            loadPrivacySettings() {
                const settings = this.analyticsManager.privacySettings;
                document.getElementById('trackingEnabled').checked = settings.trackingEnabled;
                document.getElementById('anonymizeData').checked = settings.anonymizeData;
                document.getElementById('retentionDays').value = settings.retentionDays;
            }

            async savePrivacySettings() {
                const settings = {
                    trackingEnabled: document.getElementById('trackingEnabled').checked,
                    anonymizeData: document.getElementById('anonymizeData').checked,
                    retentionDays: parseInt(document.getElementById('retentionDays').value)
                };

                const success = await this.analyticsManager.updatePrivacySettings(settings);
                if (success) {
                    alert('Privacy settings saved successfully!');
                } else {
                    alert('Failed to save privacy settings.');
                }
            }

            async exportData() {
                try {
                    const timeRange = document.getElementById('timeRange').value;
                    const report = await this.analyticsManager.generateReport(timeRange, 'json');
                    
                    if (report) {
                        const blob = new Blob([JSON.stringify(report, null, 2)], {
                            type: 'application/json'
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `analytics-report-${timeRange}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                } catch (error) {
                    console.error('Error exporting data:', error);
                    alert('Failed to export data.');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AnalyticsUI();
        });
    </script>
</body>
</html>